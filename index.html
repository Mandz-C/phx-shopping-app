<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINIX | BTL Material Management System</title>
    
    <!-- Add Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* (ALL YOUR CSS STYLES REMAIN THE SAME - NOT SHOWN FOR BREVITY) */
        /* ... Your existing CSS ... */
    </style>
</head>
<body>
    <!-- (ALL YOUR HTML REMAINS THE SAME - NOT SHOWN FOR BREVITY) -->
    <!-- ... Your existing HTML structure ... -->

    <script>
        // ==============================================
        // SUPABASE CONFIGURATION
        // ==============================================
        const SUPABASE_URL = 'https://qmmxtglgizvqilmzneqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbXh0Z2xnaXp2cWlsbXpuZXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTksImV4cCI6MjA4MDMzNDAxOX0.fpogdv4U0pbWKUPKIUTigIxtannvWOwdY6PnJtebudU';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==============================================
        // DATA STORAGE & USER MANAGEMENT
        // ==============================================
        let items = [];
        let cart = JSON.parse(localStorage.getItem('infxCart')) || [];
        let categories = [];
        let orders = [];
        let orderCounter = 1;
        const ADMIN_PASSWORD = "INFINIXBTL123";
        
        // USER IDENTIFICATION SYSTEM
        let currentUser = {
            id: localStorage.getItem('infxUserId') || null,
            name: localStorage.getItem('infxUserName') || '',
            deviceId: localStorage.getItem('infxDeviceId') || generateDeviceId()
        };
        
        // Generate unique device ID for anonymous users
        function generateDeviceId() {
            const deviceId = 'DEV' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('infxDeviceId', deviceId);
            return deviceId;
        }
        
        // Initialize user on page load
        function initializeUser() {
            if (!currentUser.id) {
                // Generate user ID if not exists
                currentUser.id = 'USER' + Math.random().toString(36).substr(2, 6).toUpperCase();
                localStorage.setItem('infxUserId', currentUser.id);
            }
            
            // Set user name from previous sessions if available
            const userName = localStorage.getItem('infxUserName');
            if (userName) {
                currentUser.name = userName;
            }
            
            console.log('Current User:', currentUser);
        }

        // ==============================================
        // PRIVACY FUNCTIONS - USER-SPECIFIC DATA
        // ==============================================

        // Save user info when submitting request
        function saveUserInfo(name, userId) {
            currentUser.name = name;
            currentUser.id = userId || currentUser.id;
            localStorage.setItem('infxUserName', name);
            localStorage.setItem('infxUserId', currentUser.id);
        }

        // Filter orders to show only user's own requests
        function filterUserOrders(allOrders) {
            return allOrders.filter(order => 
                // User can see their own orders by:
                // 1. Matching user ID (if provided during submission)
                // 2. Matching device ID (for anonymous users)
                // 3. Admin can see all (handled separately)
                order.userId === currentUser.id || 
                order.deviceId === currentUser.deviceId ||
                order.requestorName.toLowerCase() === currentUser.name.toLowerCase()
            );
        }

        // Check if user can cancel a specific order
        function canUserCancelOrder(order) {
            return (
                order.userId === currentUser.id || 
                order.deviceId === currentUser.deviceId ||
                order.requestorName.toLowerCase() === currentUser.name.toLowerCase()
            ) && order.status === 'processing';
        }

        // ==============================================
        // MODIFIED SUPABASE FUNCTIONS WITH USER DATA
        // ==============================================

        async function loadOrdersFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (*)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                orders = (data || []).map(order => ({
                    id: order.order_id,
                    requestorName: order.requestor_name,
                    userId: order.user_id,
                    deviceId: order.device_id, // NEW: Store device ID
                    shopId: order.shop_id,
                    contactNumber: order.contact_number,
                    address: order.address,
                    storeStatus: order.store_status,
                    region: order.region,
                    dateNeeded: order.date_needed,
                    notes: order.notes,
                    status: order.status,
                    date: new Date(order.created_at).toLocaleString(),
                    items: order.order_items ? order.order_items.map(oi => ({
                        itemId: oi.item_id,
                        name: oi.item_name,
                        quantity: oi.quantity
                    })) : [],
                    orderNumber: parseInt(order.order_id.replace('INFX', ''))
                }));
                
                return orders;
            } catch (error) {
                console.error('Error loading orders:', error);
                return getLocalOrders();
            }
        }

        // ==============================================
        // MODIFIED SUBMIT REQUEST FUNCTION
        // ==============================================

        async function submitRequest() {
            if(cart.length === 0) {
                alert('Your cart is empty! Please add materials first.');
                switchTab('store', null);
                return;
            }
            
            const requestorName = document.getElementById('requestorName').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const shopId = document.getElementById('shopId').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const address = document.getElementById('address').value.trim();
            const storeStatus = document.getElementById('storeStatus').value;
            const region = document.getElementById('region').value;
            const dateNeeded = document.getElementById('dateNeeded').value;
            const notes = document.getElementById('requestNotes').value.trim();
            
            if(!requestorName || !userId || !shopId || !contactNumber || !address || !storeStatus || !region || !dateNeeded) {
                alert('Please fill all required fields!');
                return;
            }
            
            // Save user info for privacy
            saveUserInfo(requestorName, userId);
            
            // Show loading
            const submitBtn = document.querySelector('button[onclick="submitRequest()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Submitting...';
            submitBtn.disabled = true;
            
            try {
                // Get order ID
                const orderId = await getNextOrderId();
                
                const orderData = {
                    id: orderId,
                    requestorName: requestorName,
                    userId: userId || currentUser.id, // Use provided ID or generated one
                    deviceId: currentUser.deviceId,   // Add device ID for privacy
                    shopId: shopId,
                    contactNumber: contactNumber,
                    address: address,
                    storeStatus: storeStatus,
                    region: region,
                    dateNeeded: dateNeeded,
                    notes: notes,
                    date: new Date().toLocaleString(),
                    items: [...cart],
                    status: 'processing'
                };
                
                // Try to submit to Supabase
                let supabaseSuccess = false;
                let supabaseError = null;
                
                try {
                    // Submit order to Supabase with user/device info
                    const { data: order, error: orderError } = await supabase
                        .from('orders')
                        .insert([{
                            order_id: orderData.id,
                            requestor_name: orderData.requestorName,
                            user_id: orderData.userId,
                            device_id: orderData.deviceId, // NEW: Store device ID
                            shop_id: orderData.shopId,
                            contact_number: orderData.contactNumber,
                            address: orderData.address,
                            store_status: orderData.storeStatus,
                            region: orderData.region,
                            date_needed: orderData.dateNeeded,
                            notes: orderData.notes,
                            status: orderData.status
                        }])
                        .select()
                        .single();
                    
                    if (orderError) throw orderError;
                    
                    // Insert order items
                    const orderItems = orderData.items.map(item => ({
                        order_id: orderData.id,
                        item_id: item.itemId,
                        item_name: item.name,
                        quantity: item.quantity
                    }));
                    
                    const { error: itemsError } = await supabase
                        .from('order_items')
                        .insert(orderItems);
                    
                    if (itemsError) throw itemsError;
                    
                    supabaseSuccess = true;
                    
                } catch (supabaseErr) {
                    console.error('Supabase submission error:', supabaseErr);
                    supabaseError = supabaseErr.message;
                    supabaseSuccess = false;
                }
                
                // Always save locally (as backup)
                orders.push(orderData);
                saveLocalData();
                
                // Clear cart
                cart = [];
                localStorage.setItem('infxCart', JSON.stringify(cart));
                
                // Update UI
                displayCart();
                updateCartCount();
                displayCustomerOrders(); // This will now show only user's orders
                displayStoreItems();
                
                // Clear form
                document.getElementById('requestorName').value = '';
                document.getElementById('userId').value = '';
                document.getElementById('shopId').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('address').value = '';
                document.getElementById('storeStatus').value = '';
                document.getElementById('region').value = '';
                document.getElementById('dateNeeded').value = '';
                document.getElementById('requestNotes').value = '';
                
                // Show appropriate success message
                if (supabaseSuccess) {
                    alert(`‚úÖ Material Request Submitted Successfully!\n\nRequest ID: ${orderId}\nName: ${requestorName}\nShop: ${shopId}\n\n‚úÖ Saved to database and locally!`);
                } else {
                    alert(`‚ö†Ô∏è Request saved locally (offline mode)\n\nRequest ID: ${orderId}\nName: ${requestorName}\nShop: ${shopId}\n\nReason: ${supabaseError || 'Network error'}\n\nData will sync when connection is restored.`);
                }
                
                switchTab('orders', null);
                
            } catch (error) {
                console.error('General submission error:', error);
                alert(`‚ùå Error: ${error.message}\n\nPlease try again or contact support.`);
            } finally {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==============================================
        // MODIFIED DISPLAY FUNCTIONS WITH PRIVACY
        // ==============================================

        function displayCustomerOrders() {
            const customerOrders = document.getElementById('customerOrders');
            customerOrders.innerHTML = '';
            
            // Filter orders to show only user's own requests
            const userOrders = filterUserOrders(orders);
            
            if(userOrders.length === 0) {
                customerOrders.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>üì≠ No Requests Found</h3>
                        <p>Your submitted requests will appear here.</p>
                        <p><small>Only you can see your requests.</small></p>
                        <button onclick="switchTab('checkout', event)" style="margin-top: 20px;">
                            üìù Submit Your First Request
                        </button>
                    </div>
                `;
                return;
            }
            
            const sortedOrders = [...userOrders].sort((a, b) => b.orderNumber - a.orderNumber);
            
            sortedOrders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-card';
                
                // Check if user can cancel this order
                const canCancel = canUserCancelOrder(order);
                
                orderDiv.innerHTML = `
                    <div class="order-id">${order.id}</div>
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>üë§ Your Request</strong>
                    </div>
                    <p><strong>Requestor:</strong> ${order.requestorName} ${order.userId ? `(ID: ${order.userId})` : ''}</p>
                    <p><strong>Shop:</strong> ${order.shopId} ‚Ä¢ ${order.storeStatus} ‚Ä¢ ${order.region}</p>
                    <p><strong>Contact:</strong> ${order.contactNumber}</p>
                    <p><strong>Address:</strong> ${order.address}</p>
                    <p><strong>Date Needed:</strong> ${order.dateNeeded}</p>
                    <p><strong>Date Requested:</strong> ${order.date}</p>
                    <p><strong>Materials:</strong> ${order.items.map(item => `${item.name} √ó ${item.quantity}`).join(', ')}</p>
                    <p><strong>Status:</strong> <span class="status ${order.status}">${order.status.toUpperCase()}</span></p>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <button onclick="viewOrderDetails('${order.id}')">üìã View Details</button>
                        <button onclick="trackSpecificOrder('${order.id}')">üìç Track Request</button>
                        ${canCancel ? `<button class="cancel" onclick="cancelOrder('${order.id}')">‚ùå Cancel Request</button>` : ''}
                        ${!canCancel && order.status === 'processing' ? 
                            `<div style="color: #666; font-size: 12px; margin-top: 5px;">
                                ‚ö†Ô∏è Only the original requestor can cancel this request
                            </div>` : ''}
                    </div>
                `;
                customerOrders.appendChild(orderDiv);
            });
        }

        function cancelOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                alert('Order not found!');
                return;
            }
            
            // Check if user is allowed to cancel this order
            if (!canUserCancelOrder(order)) {
                alert('‚ö†Ô∏è You are not authorized to cancel this request.\n\nOnly the original requestor can cancel their own requests.');
                return;
            }
            
            if(confirm('Are you sure you want to cancel this request?')) {
                if(order && order.status === 'processing') {
                    order.status = 'cancelled';
                    order.items.forEach(orderItem => {
                        const item = items.find(i => i.id == orderItem.itemId);
                        if(item) item.stock += orderItem.quantity;
                    });
                    
                    saveLocalData();
                    displayCustomerOrders();
                    displayStoreItems();
                    alert('‚úÖ Your request has been cancelled successfully.');
                }
            }
        }

        // ==============================================
        // MODIFIED ADMIN FUNCTIONS - SEE ALL ORDERS
        // ==============================================

        function displayOrdersAdmin() {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            
            if(orders.length === 0) {
                orderList.innerHTML = '<p>No requests yet.</p>';
                return;
            }
            
            const sortedOrders = [...orders].sort((a, b) => b.orderNumber - a.orderNumber);
            
            sortedOrders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-card';
                
                // ADMIN VIEW: Show user identification info
                const userInfo = [];
                if (order.userId) userInfo.push(`User ID: ${order.userId}`);
                if (order.deviceId) userInfo.push(`Device: ${order.deviceId}`);
                
                orderDiv.innerHTML = `
                    <h4>
                        <span class="order-id">${order.id}</span> 
                        <span style="font-size: 14px; color: #666; margin-left: 10px;">
                            üë§ ${order.requestorName}
                        </span>
                    </h4>
                    ${userInfo.length > 0 ? 
                        `<div style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; margin: 5px 0; font-size: 12px;">
                            ${userInfo.join(' ‚Ä¢ ')}
                        </div>` : ''}
                    <p><strong>Shop:</strong> ${order.shopId} ‚Ä¢ ${order.storeStatus} ‚Ä¢ ${order.region}</p>
                    <p><strong>Contact:</strong> ${order.contactNumber}</p>
                    <p><strong>Address:</strong> ${order.address}</p>
                    <p><strong>Date Needed:</strong> ${order.dateNeeded}</p>
                    <p><strong>Date Requested:</strong> ${order.date}</p>
                    <p><strong>Materials:</strong> ${order.items.map(item => `${item.name} (x${item.quantity})`).join(', ')}</p>
                    <p><strong>Total Items:</strong> ${order.items.reduce((sum, item) => sum + item.quantity, 0)}</p>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    <p><strong>Status:</strong> 
                        <span class="status ${order.status}">${order.status.toUpperCase()}</span>
                        <select onchange="updateOrderStatus('${order.id}', this.value)" style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 2px solid #ddd;">
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Approved</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </p>
                    <button onclick="viewOrderDetails('${order.id}')">View Details</button>
                    <button onclick="adminTrackOrder('${order.id}')">Track Order</button>
                    <button class="cancel" onclick="adminCancelOrder('${order.id}')">Admin Cancel</button>
                `;
                orderList.appendChild(orderDiv);
            });
        }

        // Admin can cancel any order
        function adminCancelOrder(orderId) {
            if(!confirm('‚ö†Ô∏è ADMIN: Cancel this request?\n\nThis action cannot be undone.')) {
                return;
            }
            
            const order = orders.find(o => o.id === orderId);
            if(order) {
                const oldStatus = order.status;
                order.status = 'cancelled';
                
                // Restore stock if order was active
                if(oldStatus === 'processing' || oldStatus === 'shipped') {
                    order.items.forEach(orderItem => {
                        const item = items.find(i => i.id == orderItem.itemId);
                        if(item) item.stock += orderItem.quantity;
                    });
                }
                
                saveLocalData();
                displayOrdersAdmin();
                displayCustomerOrders();
                displayStoreItems();
                alert('‚úÖ Request cancelled by admin.');
            }
        }

        function adminTrackOrder(orderId) {
            alert('Admin tracking order: ' + orderId);
            // You can implement admin-specific tracking here
        }

        // ==============================================
        // MODIFIED TRACK ORDER FUNCTION
        // ==============================================

        function trackOrder() {
            const orderId = document.getElementById('trackOrderId').value.trim().toUpperCase();
            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');
            
            if(!orderId) {
                alert('Please enter a Request ID');
                return;
            }
            
            const order = orders.find(o => o.id === orderId);
            
            if(!order) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        <h3>‚ùå Request Not Found</h3>
                        <p>Request ID "${orderId}" was not found.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }
            
            // Check if user is allowed to view this order
            const canView = canUserCancelOrder(order);
            
            if (!canView) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        <h3>üîí Access Denied</h3>
                        <p>You can only track your own requests.</p>
                        <p><small>Request ID: ${orderId}</small></p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }
            
            // Update progress tracker
            const steps = document.querySelectorAll('.tracker-step');
            const statusIndex = {
                'processing': 1,
                'shipped': 2,
                'delivered': 3,
                'cancelled': -1
            };
            
            steps.forEach((step, index) => {
                const circle = step.querySelector('.step-circle');
                const label = step.querySelector('.step-label');
                
                if(index <= statusIndex[order.status]) {
                    circle.classList.add('active');
                    label.classList.add('active');
                } else {
                    circle.classList.remove('active');
                    label.classList.remove('active');
                }
            });
            
            if(order.status === 'cancelled') {
                steps.forEach(step => {
                    step.querySelector('.step-circle').classList.remove('active');
                    step.querySelector('.step-label').classList.remove('active');
                });
            }
            
            detailsDiv.innerHTML = `
                <h3>üì¶ Request Tracking: ${order.id}</h3>
                <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>üë§ Your Request</strong>
                </div>
                <p><strong>Requestor:</strong> ${order.requestorName}</p>
                <p><strong>Shop ID:</strong> ${order.shopId} (${order.storeStatus}, ${order.region})</p>
                <p><strong>Contact:</strong> ${order.contactNumber}</p>
                <p><strong>Address:</strong> ${order.address}</p>
                <p><strong>Date Needed:</strong> ${order.dateNeeded}</p>
                <p><strong>Request Date:</strong> ${order.date}</p>
                <p><strong>Current Status:</strong> <span class="status ${order.status}">${order.status.toUpperCase()}</span></p>
                <p><strong>Materials:</strong> ${order.items.map(item => `${item.name} √ó ${item.quantity}`).join(', ')}</p>
                ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                ${order.status === 'cancelled' ? 
                    '<div style="background: #fde8e8; padding: 15px; border-radius: 8px; margin-top: 15px;"><strong>‚ö†Ô∏è This request has been cancelled.</strong></div>' : ''}
            `;
            
            resultDiv.style.display = 'block';
        }

        // ==============================================
        // ADD USER SWITCHING FOR TESTING (OPTIONAL)
        // ==============================================

        function switchUser() {
            if(confirm('Switch to a different user?\n\nThis will clear your current session.')) {
                localStorage.removeItem('infxUserId');
                localStorage.removeItem('infxUserName');
                localStorage.removeItem('infxDeviceId');
                localStorage.removeItem('infxOrders');
                
                // Generate new user
                initializeUser();
                
                // Reload page
                location.reload();
            }
        }

        // ==============================================
        // MODIFIED INITIALIZATION
        // ==============================================

        async function initializeApp() {
            try {
                // Initialize user first
                initializeUser();
                
                // Load data from Supabase
                items = await loadItemsFromSupabase();
                categories = await loadCategoriesFromSupabase();
                orders = await loadOrdersFromSupabase();
                
                // Initialize UI
                initializeCategoryDropdown();
                displayStoreItems();
                updateCartCount();
                displayCategoriesAdmin();
                updateStoreLink();
                updateHomeStats();
                
                // Show user info (optional)
                if (currentUser.name) {
                    document.getElementById('home-tab').innerHTML += `
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                            <h4>üë§ Welcome, ${currentUser.name}!</h4>
                            <p>User ID: ${currentUser.id}</p>
                            <button onclick="switchUser()" style="font-size: 12px; padding: 5px 10px;">Switch User</button>
                        </div>
                    `;
                }
                
                // Save local backup
                saveLocalData();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback to local data
                items = getLocalItems();
                categories = getLocalCategories();
                orders = getLocalOrders();
                orderCounter = parseInt(localStorage.getItem('infxOrderCounter')) || 1;
                
                initializeCategoryDropdown();
                displayStoreItems();
                updateCartCount();
                displayCategoriesAdmin();
                updateStoreLink();
                updateHomeStats();
            }
        }

        // ==============================================
        // REST OF YOUR FUNCTIONS REMAIN THE SAME
        // ==============================================
        // (All other functions like switchTab, addToCart, etc. remain unchanged)
        // ...

        // Initialize on load
        window.onload = initializeApp;
    </script>
</body>
</html>