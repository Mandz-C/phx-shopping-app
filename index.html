// ==============================================
// SUPABASE CONFIGURATION
// ==============================================
const supabaseUrl = 'https://qmmxtglgizvqilmzneqn.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbXh0Z2xnaXp2cWlsbXpuZXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTksImV4cCI6MjA4MDMzNDAxOX0.fpogdv4U0pbWKUPKIUTigIxtannvWOwdY6PnJtebudU';

const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ==============================================
// GLOBAL VARIABLES
// ==============================================
let items = [];
let cart = JSON.parse(localStorage.getItem('infxCart')) || [];
let categories = [];
let orders = [];
let notifications = JSON.parse(localStorage.getItem('infxNotifications')) || [];
let currentOrderFilter = 'all';
const ADMIN_PASSWORD = "INFINIXBTL123";

// USER IDENTIFICATION
let currentUser = {
    id: localStorage.getItem('infxUserId') || null,
    name: localStorage.getItem('infxUserName') || '',
    deviceId: localStorage.getItem('infxDeviceId') || generateDeviceId()
};

function generateDeviceId() {
    const deviceId = 'DEV' + Math.random().toString(36).substr(2, 9).toUpperCase();
    localStorage.setItem('infxDeviceId', deviceId);
    return deviceId;
}

// ==============================================
// NOTIFICATION SYSTEM (keep existing functions)
// ==============================================

// ==============================================
// FIXED SUPABASE FUNCTIONS
// ==============================================

async function loadItems() {
    try {
        const { data, error } = await supabase
            .from('materials')
            .select('*')
            .order('name');
            
        if (error) throw error;
        items = data;
        displayStoreItems();
        updateHomeStats();
    } catch (error) {
        console.error('Error loading items:', error);
        items = [];
        displayStoreItems();
    }
}

async function loadCategories() {
    try {
        const { data, error } = await supabase
            .from('categories')
            .select('*')
            .order('name');
            
        if (error) throw error;
        categories = data.map(cat => cat.name);
        initializeCategoryDropdown();
    } catch (error) {
        console.error('Error loading categories:', error);
        categories = ['Marketing Materials', 'Display Units', 'POS Materials', 'Stationery', 'Branding Items'];
        initializeCategoryDropdown();
    }
}

async function loadOrders() {
    try {
        const { data, error } = await supabase
            .from('orders')
            .select('*')
            .order('created_at', { ascending: false });
            
        if (error) throw error;
        
        orders = data.map(order => ({
            id: order.order_id,
            requestorName: order.requestor_name,
            userId: order.user_id,
            deviceId: order.device_id,
            shopId: order.shop_id,
            contactNumber: order.contact_number,
            address: order.address,
            storeStatus: order.store_status,
            region: order.region,
            dateNeeded: order.date_needed,
            notes: order.notes,
            date: new Date(order.created_at).toLocaleString(),
            status: order.status || 'pending',
            items: order.items || [],
            returnRequest: order.return_request
        }));
        
        displayCustomerOrders();
        updateHomeStats();
    } catch (error) {
        console.error('Error loading orders:', error);
        orders = [];
        displayCustomerOrders();
    }
}

async function submitOrder(orderData) {
    try {
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert({
                order_id: orderData.id,
                requestor_name: orderData.requestorName,
                user_id: orderData.userId,
                device_id: orderData.deviceId,
                shop_id: orderData.shopId,
                contact_number: orderData.contactNumber,
                address: orderData.address,
                store_status: orderData.storeStatus,
                region: orderData.region,
                date_needed: orderData.dateNeeded,
                notes: orderData.notes,
                status: 'pending',
                items: orderData.items
            })
            .select()
            .single();
            
        if (orderError) throw orderError;
        
        // Clear cart
        cart = [];
        localStorage.setItem('infxCart', JSON.stringify(cart));
        updateCartCount();
        
        // Reload data
        await loadOrders();
        
        addNotification(
            'status_update',
            'ðŸ“¦ New Request Submitted',
            `Your request ${orderData.id} has been submitted successfully.`,
            orderData.id,
            currentUser.id
        );
        
        return true;
    } catch (error) {
        console.error('Error submitting order:', error);
        alert('Error submitting order. Please try again.');
        return false;
    }
}

// FIXED: This function wasn't working properly
async function updateOrderStatus(orderId, newStatus) {
    try {
        console.log('Updating order status:', orderId, 'to:', newStatus);
        
        const { data, error } = await supabase
            .from('orders')
            .update({ 
                status: newStatus 
            })
            .eq('order_id', orderId)
            .select();
            
        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('Update response:', data);
        
        // Update local data
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            orders[orderIndex].status = newStatus;
        }
        
        // Send notification
        const statusMessages = {
            'pending': 'is pending review',
            'approved': 'has been approved by management',
            'released': 'has been released from warehouse',
            'completed': 'has been completed',
            'cancelled': 'has been cancelled',
            'rejected': 'has been rejected'
        };
        
        if (statusMessages[newStatus]) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                addNotification(
                    'status_update',
                    `ðŸ“¦ Order Status Update`,
                    `Your order ${orderId} ${statusMessages[newStatus]}.`,
                    orderId,
                    order.userId
                );
            }
        }
        
        // Reload orders to get fresh data
        await loadOrders();
        
        // Update admin panel if open
        if (document.getElementById('adminContent').style.display === 'block') {
            displayOrdersAdmin();
        }
        
        alert(`âœ… Order ${orderId} status updated to ${newStatus}`);
        return true;
    } catch (error) {
        console.error('Error updating order status:', error);
        alert('Error updating order status: ' + error.message);
        return false;
    }
}

// ==============================================
// NEW ADMIN FUNCTION: Add Material
// ==============================================

async function addNewMaterial() {
    const name = document.getElementById('newMaterialName').value.trim();
    const description = document.getElementById('newMaterialDescription').value.trim();
    const category = document.getElementById('newMaterialCategory').value;
    const stock = parseInt(document.getElementById('newMaterialStock').value) || 0;
    
    if (!name) {
        alert('Please enter material name');
        return;
    }
    
    if (!category) {
        alert('Please select a category');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('materials')
            .insert({
                name: name,
                description: description,
                category: category,
                stock: stock
            })
            .select();
            
        if (error) throw error;
        
        // Clear form
        document.getElementById('newMaterialName').value = '';
        document.getElementById('newMaterialDescription').value = '';
        document.getElementById('newMaterialCategory').value = '';
        document.getElementById('newMaterialStock').value = '0';
        
        // Reload items
        await loadItems();
        
        // Update admin display
        displayItemsAdmin();
        
        alert('âœ… Material added successfully!');
    } catch (error) {
        console.error('Error adding material:', error);
        alert('Error adding material: ' + error.message);
    }
}

async function deleteMaterial(itemId) {
    if (!confirm('Are you sure you want to delete this material?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('materials')
            .delete()
            .eq('id', itemId);
            
        if (error) throw error;
        
        // Reload items
        await loadItems();
        
        // Update admin display
        displayItemsAdmin();
        
        alert('âœ… Material deleted successfully!');
    } catch (error) {
        console.error('Error deleting material:', error);
        alert('Error deleting material: ' + error.message);
    }
}

async function updateMaterialStock(itemId, newStock) {
    try {
        const { error } = await supabase
            .from('materials')
            .update({ stock: newStock })
            .eq('id', itemId);
            
        if (error) throw error;
        
        // Reload items
        await loadItems();
        
        // Update admin display
        displayItemsAdmin();
        
        alert('âœ… Stock updated successfully!');
    } catch (error) {
        console.error('Error updating stock:', error);
        alert('Error updating stock: ' + error.message);
    }
}

// ==============================================
// UPDATED ADMIN PANEL HTML (Add to your existing HTML)
// ==============================================

// Add this section to your admin panel HTML, inside the admin-content div:
// Replace your current "ITEMS TAB" section with this:

/*
<!-- ITEMS TAB -->
<div id="admin-items-tab" class="admin-tab-content active" style="display: block; max-height: 500px; overflow-y: auto; padding: 15px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
        <!-- Add New Material Form -->
        <div class="admin-section" style="margin-bottom: 25px; padding: 25px; background: #2D2D2D; border-radius: 10px; border-left: 5px solid #71B340;">
            <h3><i class="fas fa-plus"></i> Add New Material</h3>
            <div style="margin-bottom: 15px;">
                <div class="form-label">Material Name *</div>
                <input type="text" id="newMaterialName" placeholder="Enter material name" required>
            </div>
            <div style="margin-bottom: 15px;">
                <div class="form-label">Description</div>
                <textarea id="newMaterialDescription" placeholder="Enter description" rows="3"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <div class="form-label">Category *</div>
                <select id="newMaterialCategory" style="width: 100%; padding: 12px; background: #2D2D2D; color: #E0E0E0; border: 2px solid #3C3C3C; border-radius: 8px;">
                    <option value="">Select Category</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="form-label">Initial Stock *</div>
                <input type="number" id="newMaterialStock" value="0" min="0" required>
            </div>
            <button class="success" onclick="addNewMaterial()"><i class="fas fa-plus"></i> Add Material</button>
        </div>
        
        <!-- Manage Materials -->
        <div class="admin-section" style="margin-bottom: 25px; padding: 25px; background: #2D2D2D; border-radius: 10px; border-left: 5px solid #71B340;">
            <h3><i class="fas fa-boxes"></i> Manage Materials</h3>
            <div id="stockList" style="max-height: 400px; overflow-y: auto;">
                <div class="loading">Loading materials...</div>
            </div>
        </div>
    </div>
</div>
*/

// ==============================================
// UPDATED ADMIN ITEMS DISPLAY FUNCTION
// ==============================================

function displayItemsAdmin() {
    const stockList = document.getElementById('stockList');
    if (!stockList) return;
    
    stockList.innerHTML = '';
    
    if (items.length === 0) {
        stockList.innerHTML = '<p style="text-align: center; padding: 20px; color: #E0E0E0;">No materials found. Add your first material!</p>';
        return;
    }
    
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-card';
        itemDiv.style.cssText = `
            background: #2D2D2D;
            border: 1px solid #3C3C3C;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        `;
        
        itemDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 10px 0; color: white;">${item.name}</h4>
                    ${item.description ? `<p style="color: #E0E0E0; margin-bottom: 10px; font-size: 14px;">${item.description}</p>` : ''}
                    <div>
                        <span class="category-tag" style="display: inline-block; background: linear-gradient(135deg, #3C3C3C 0%, #4A4A4A 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; margin-bottom: 8px; border: 1px solid #4A4A4A;">${item.category || 'Uncategorized'}</span>
                        <span style="color: ${item.stock > 10 ? '#4CAF50' : item.stock > 0 ? '#FF9800' : '#F44336'}; font-weight: 600;">Stock: ${item.stock} units</span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-left: 15px;">
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="stock-${item.id}" value="${item.stock}" min="0" style="width: 80px; padding: 8px; background: #1E1E1E; color: #E0E0E0; border: 1px solid #3C3C3C; border-radius: 6px;">
                        <button onclick="updateMaterialStock(${item.id}, document.getElementById('stock-${item.id}').value)" style="padding: 8px 15px; font-size: 13px;">Update</button>
                    </div>
                    <button class="cancel" onclick="deleteMaterial(${item.id})" style="padding: 8px 15px; font-size: 13px;"><i class="fas fa-trash"></i> Delete</button>
                </div>
            </div>
        `;
        stockList.appendChild(itemDiv);
    });
}

// ==============================================
// UPDATED INITIALIZATION
// ==============================================

async function initializeApp() {
    if (!currentUser.id) {
        currentUser.id = 'USER' + Math.random().toString(36).substr(2, 6).toUpperCase();
        localStorage.setItem('infxUserId', currentUser.id);
    }
    
    if (!localStorage.getItem('infxOrderCounter')) {
        localStorage.setItem('infxOrderCounter', '1');
    }
    
    // Load data from Supabase
    await loadItems();
    await loadCategories();
    await loadOrders();
    
    // Update UI
    initializeCategoryDropdown();
    updateCartCount();
    updateHomeStats();
    updateStoreLink();
    updateNotificationCount();
    
    // Initialize admin category dropdown
    initializeAdminCategoryDropdown();
}

function initializeAdminCategoryDropdown() {
    const select = document.getElementById('newMaterialCategory');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Category</option>';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

// ==============================================
// FIXED CATEGORY FUNCTIONS
// ==============================================

async function addCategory() {
    const categoryName = document.getElementById('newCategoryName').value.trim();
    
    if(!categoryName) {
        alert('Please enter a category name');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('categories')
            .insert({ name: categoryName })
            .select();
            
        if (error) throw error;
        
        // Reload categories
        await loadCategories();
        
        document.getElementById('newCategoryName').value = '';
        alert(`âœ… Category "${categoryName}" added successfully!`);
    } catch (error) {
        console.error('Error adding category:', error);
        alert('Error adding category: ' + error.message);
    }
}

async function deleteCategory(categoryName) {
    if(!confirm(`Delete category "${categoryName}"? This will remove the category from all materials.`)) {
        return;
    }
    
    try {
        // Delete category from database
        const { error } = await supabase
            .from('categories')
            .delete()
            .eq('name', categoryName);
            
        if (error) throw error;
        
        // Update materials to remove this category
        const { error: updateError } = await supabase
            .from('materials')
            .update({ category: null })
            .eq('category', categoryName);
            
        if (updateError) throw updateError;
        
        // Reload data
        await loadCategories();
        await loadItems();
        
        alert(`âœ… Category "${categoryName}" deleted successfully!`);
    } catch (error) {
        console.error('Error deleting category:', error);
        alert('Error deleting category: ' + error.message);
    }
}

// ==============================================
// INITIALIZE THE APP
// ==============================================
window.onload = initializeApp;