<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINIX | BTL Material Management System</title>
    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Keep all your existing CSS styles - they remain the same] */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        :root {
            --dark-green: #11270B;
            --main-green: #71B340;
            --light-green: #669D31;
            --accent-green: #598B2C;
            --deep-green: #3C5A14;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--deep-green) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* ... [Keep all other CSS styles exactly as they were] ... */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--main-green);
            font-weight: bold;
        }
        .loading:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: var(--main-green); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 var(--main-green), .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 var(--main-green), .5em 0 0 var(--main-green); }
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c00;
        }
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #155724;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="logo">INFINIX</span> | BTL Material Management System</h1>
        <p>Efficient Material Request & Tracking System</p>
    </div>

    <!-- BANNER -->
    <div class="banner-container">
        <div class="banner-scroll">
            <span>Together We Grow. Together We Win. Infinix 2026!</span>
            <span>BTL Material Management System</span>
            <span>Efficient ‚Ä¢ Organized ‚Ä¢ Professional</span>
        </div>
    </div>

    <!-- CUSTOMER TABS -->
    <div class="tab-buttons" id="customerTabs">
        <button class="tab-btn active" onclick="switchTab('home')">üè† Home</button>
        <button class="tab-btn" onclick="switchTab('store')">üõçÔ∏è Materials</button>
        <button class="tab-btn" onclick="switchTab('cart')">üõí Cart (<span id="cartCount">0</span>)</button>
        <button class="tab-btn" onclick="switchTab('checkout')">üìù Submit Request</button>
        <button class="tab-btn" onclick="switchTab('orders')">üì¶ My Requests</button>
        <button class="tab-btn" onclick="switchTab('track')">üìç Track Request</button>
        <button class="tab-btn" onclick="switchTab('about')">üë• About</button>
    </div>

    <!-- HOME TAB -->
    <div id="home-tab" class="tab-content active">
        <div class="section">
            <div class="home-hero">
                <h2>Welcome to the BTL Material Management System</h2>
                <p>Streamline your material requests with our efficient system. Request, track, and manage all your BTL materials in one place.</p>
                <button class="success" onclick="switchTab('store')">Browse Materials ‚Üí</button>
            </div>
            
            <h3>üìä System Overview</h3>
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number" id="homeTotalProducts">0</div>
                    <div class="stat-label">Available Materials</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="homeTotalOrders">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="homeActiveOrders">0</div>
                    <div class="stat-label">Active Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="homeDeliveredOrders">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <h3>üöÄ Quick Actions</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
                <button onclick="switchTab('store')">Browse Materials</button>
                <button onclick="switchTab('checkout')">Submit Request</button>
                <button onclick="switchTab('track')">Track Request</button>
                <button class="success" onclick="showAdminPanel()">Admin Panel</button>
            </div>
        </div>
    </div>

    <!-- STORE TAB -->
    <div id="store-tab" class="tab-content">
        <div class="section">
            <h2>üõçÔ∏è Available Materials</h2>
            <div class="category-select">
                <label for="categoryFilter" style="font-weight: bold; color: var(--dark-green);">Filter by Category:</label>
                <select id="categoryFilter" onchange="filterCategory(this.value)">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <div id="storeItems"></div>
        </div>
    </div>

    <!-- CART TAB -->
    <div id="cart-tab" class="tab-content">
        <div class="section">
            <h2>üõí Your Cart</h2>
            <div id="cartItems"></div>
            <div class="cart-total" id="cartTotal">Total Items: 0</div>
            <button class="success" onclick="switchTab('checkout')">‚úÖ Proceed to Submit Request</button>
            <button class="cancel" onclick="clearCart()">üóëÔ∏è Clear Cart</button>
        </div>
    </div>

    <!-- CHECKOUT TAB -->
    <div id="checkout-tab" class="tab-content">
        <div class="section">
            <h2>üìù Submit Material Request</h2>
            
            <div class="order-summary">
                <h3>üì¶ Items in Your Cart</h3>
                <div id="checkoutSummary"></div>
                <div class="summary-total" id="checkoutSummaryTotal">Total Items: 0</div>
            </div>
            
            <div class="checkout-form">
                <h3>üë§ Requester Information</h3>
                
                <div class="form-group">
                    <label>Requestor's Full Name *</label>
                    <input type="text" id="requestorName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>User ID # *</label>
                        <input type="text" id="userId" placeholder="e.g., 12345" required>
                    </div>
                    <div class="form-group">
                        <label>Shop ID *</label>
                        <input type="text" id="shopId" placeholder="e.g., SHOP001" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Contact Number *</label>
                        <input type="tel" id="contactNumber" placeholder="e.g., 09171234567" required>
                    </div>
                    <div class="form-group">
                        <label>Store Status *</label>
                        <select id="storeStatus" required>
                            <option value="">Select Status</option>
                            <option value="New">New</option>
                            <option value="Existing">Existing</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Address *</label>
                    <textarea id="address" placeholder="Enter complete address" rows="3" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Region *</label>
                        <select id="region" required>
                            <option value="">Select Region</option>
                            <option value="NCR">NCR</option>
                            <option value="North Luzon">North Luzon</option>
                            <option value="Central Luzon">Central Luzon</option>
                            <option value="South Luzon">South Luzon</option>
                            <option value="Visayas">Visayas</option>
                            <option value="Mindanao">Mindanao</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Needed *</label>
                        <input type="date" id="dateNeeded" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes (Optional)</label>
                    <textarea id="requestNotes" placeholder="Any additional information or special instructions..." rows="3"></textarea>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="success" onclick="submitRequest()" style="padding: 15px 40px; font-size: 18px;">
                        ‚úÖ Submit Material Request
                    </button>
                    <button class="cancel" onclick="switchTab('cart')">‚Üê Back to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDERS TAB -->
    <div id="orders-tab" class="tab-content">
        <div class="section">
            <h2>üì¶ My Material Requests</h2>
            <input type="text" id="orderSearch" placeholder="üîç Search by Request ID or Material" onkeyup="searchOrders()">
            <div id="customerOrders"></div>
        </div>
    </div>

    <!-- TRACK ORDER TAB -->
    <div id="track-tab" class="tab-content">
        <div class="section">
            <h2>üìç Track Your Request</h2>
            <div class="order-tracking">
                <p>Enter your Request ID to track status:</p>
                <div class="tracking-input">
                    <input type="text" id="trackOrderId" placeholder="Enter Request ID (e.g., INFX00001)">
                    <button onclick="trackOrder()">üîç Track Request</button>
                </div>
                <div class="tracking-result" id="trackingResult" style="display: none;">
                    <div class="order-details" id="trackingDetails"></div>
                    <div class="progress-tracker" id="progressTracker">
                        <div class="tracker-step">
                            <div class="step-circle">1</div>
                            <div class="step-label">Request Submitted</div>
                        </div>
                        <div class="tracker-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Processing</div>
                        </div>
                        <div class="tracker-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Approved</div>
                        </div>
                        <div class="tracker-step">
                            <div class="step-circle">4</div>
                            <div class="step-label">Delivered</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ABOUT TAB -->
    <div id="about-tab" class="tab-content">
        <div class="section">
            <h2>üë• BTL Team</h2>
            <p style="margin-bottom: 20px; color: var(--deep-green);">Meet the team behind the BTL Material Management System</p>
            
            <div class="team-grid">
                <div class="team-card">
                    <h4>King Rey Calinawan Mateo</h4>
                    <div class="position">BTL Supervisor</div>
                    <div class="nickname">King</div>
                    <p style="margin-top: 15px; color: #666;">Oversees all BTL operations and material management.</p>
                </div>
                
                <div class="team-card">
                    <h4>Jover Cruz Pe√±a</h4>
                    <div class="position">BTL Specialist</div>
                    <div class="nickname">Ethan</div>
                    <p style="margin-top: 15px; color: #666;">Handles material coordination and deployment.</p>
                </div>
                
                <div class="team-card">
                    <h4>Armando Cristobal Jr</h4>
                    <div class="position">Data Analyst</div>
                    <p style="margin-top: 15px; color: #666;">Manages data analysis and system optimization.</p>
                </div>
            </div>

            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                <h3>üì± Share This System</h3>
                <div class="share-link">
                    <p>Share this link with team members:</p>
                    <input type="text" id="storeLink" readonly>
                    <button onclick="copyStoreLink()">üìã Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div class="admin-key" onclick="showAdminPanel()">
        <span>üîë</span>
        <span>Admin Panel</span>
    </div>
    
    <div class="admin-overlay" id="adminOverlay" onclick="hideAdminPanel()"></div>
    
    <div class="admin-panel" id="adminPanel">
        <button class="close-admin" onclick="hideAdminPanel()">√ó</button>
        <h2>üîê Admin Dashboard</h2>
        
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Admin Password:</label>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="adminPassword" placeholder="Enter admin password" style="flex: 1;">
                <button onclick="verifyAdmin()">üîì Access Panel</button>
            </div>
        </div>
        
        <div id="adminContent" style="display: none;">
            <div class="admin-tabs">
                <button class="admin-tab-btn active" onclick="switchAdminTab('items')">üì¶ Materials</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('categories')">üè∑Ô∏è Categories</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('orders')">üìã Requests</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('export')">üìä Export</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('users')">üë• Users</button>
            </div>
            
            <!-- ITEMS TAB -->
            <div id="admin-items-tab" class="admin-tab-content active">
                <div class="admin-section">
                    <h3>‚ûï Add New Material</h3>
                    <input type="text" id="itemName" placeholder="Material Name *" required>
                    <select id="itemCategory" required>
                        <option value="">Select Category *</option>
                    </select>
                    <input type="number" id="itemStock" placeholder="Initial Stock *" required>
                    <textarea id="itemDesc" placeholder="Description (Optional)" rows="3"></textarea>
                    <button class="success" onclick="addItem()">‚ûï Add Material</button>
                </div>
                
                <div class="admin-section">
                    <h3>üì¶ Manage Stock</h3>
                    <div id="stockList"></div>
                </div>
            </div>
            
            <!-- CATEGORIES TAB -->
            <div id="admin-categories-tab" class="admin-tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="admin-section">
                        <h3>üè∑Ô∏è Add New Category</h3>
                        <input type="text" id="newCategoryName" placeholder="Category Name *" required>
                        <button class="success" onclick="addCategory()">‚ûï Add Category</button>
                    </div>
                    
                    <div class="admin-section">
                        <h3>üìã Manage Categories</h3>
                        <div id="categoryList"></div>
                    </div>
                </div>
            </div>
            
            <!-- ORDERS TAB -->
            <div id="admin-orders-tab" class="admin-tab-content">
                <div class="admin-section">
                    <h3>üìã All Material Requests</h3>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="adminOrderSearch" placeholder="Search requests..." onkeyup="searchAdminOrders()">
                    </div>
                    <div id="orderList"></div>
                </div>
            </div>
            
            <!-- EXPORT TAB -->
            <div id="admin-export-tab" class="admin-tab-content">
                <div class="admin-section">
                    <h3>üìä Export Data</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button onclick="exportToExcel('orders')" style="padding: 20px; text-align: center;">
                            üìã Export Requests<br>
                            <small>All request data</small>
                        </button>
                        <button onclick="exportToExcel('items')" style="padding: 20px; text-align: center;">
                            üì¶ Export Materials<br>
                            <small>Material inventory</small>
                        </button>
                        <button onclick="backupData()" style="padding: 20px; text-align: center;">
                            üíæ Backup Data<br>
                            <small>Full system backup</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="admin-users-tab" class="admin-tab-content">
                <div class="admin-section">
                    <h3>üë• Registered Users</h3>
                    <div style="margin-bottom: 20px;">
                        <button onclick="loadUsers()">üîÑ Refresh Users List</button>
                    </div>
                    <div id="userList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://qmmxtglgizvqilmzneqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbXh0Z2xnaXp2cWlsbXpuZXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTksImV4cCI6MjA4MDMzNDAxOX0.fpogdv4U0pbWKUPKIUTigIxtannvWOwdY6PnJtebudU';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Data Storage
        let items = [];
        let cart = JSON.parse(localStorage.getItem('infxCart')) || [];
        let orders = [];
        let categories = [];
        let users = [];
        let orderCounter = 1;
        const ADMIN_PASSWORD = "INFINIXBTL123";

        // Initialize categories dropdown
        function initializeCategoryDropdown() {
            const select = document.getElementById('itemCategory');
            const filterSelect = document.getElementById('categoryFilter');
            
            select.innerHTML = '<option value="">Select Category *</option>';
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name || category;
                option.textContent = category.name || category;
                select.appendChild(option.cloneNode(true));
                
                const filterOption = document.createElement('option');
                filterOption.value = category.name || category;
                filterOption.textContent = category.name || category;
                filterSelect.appendChild(filterOption);
            });
        }

        // Display categories in admin panel
        async function displayCategoriesAdmin() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '<div class="loading">Loading categories</div>';
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                if(data.length === 0) {
                    categoryList.innerHTML = '<p>No categories yet. Add your first category!</p>';
                    return;
                }
                
                categoryList.innerHTML = '';
                
                for (const category of data) {
                    // Count items in this category
                    const { count, error: countError } = await supabase
                        .from('items')
                        .select('*', { count: 'exact', head: true })
                        .eq('category_id', category.id);
                    
                    if (countError) throw countError;
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-item';
                    categoryDiv.innerHTML = `
                        <div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-count">${count || 0} items</div>
                        </div>
                        <div>
                            <button onclick="editCategory(${category.id}, '${category.name}')">‚úèÔ∏è Edit</button>
                            <button class="cancel" onclick="deleteCategory(${category.id})">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    categoryList.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                categoryList.innerHTML = `<div class="error">Error loading categories: ${error.message}</div>`;
            }
        }

        // Add new category
        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if(!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .insert([{ name: categoryName }])
                    .select();
                
                if (error) throw error;
                
                // Refresh categories list
                await loadCategories();
                displayCategoriesAdmin();
                
                document.getElementById('newCategoryName').value = '';
                alert(`Category "${categoryName}" added successfully!`);
            } catch (error) {
                console.error('Error adding category:', error);
                alert(`Error adding category: ${error.message}`);
            }
        }

        // Edit category
        async function editCategory(categoryId, oldName) {
            const newName = prompt('Enter new category name:', oldName);
            
            if(!newName || newName.trim() === '') {
                alert('Category name cannot be empty!');
                return;
            }
            
            if(newName === oldName) return;
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .update({ name: newName })
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                // Update items with this category
                const { error: updateError } = await supabase
                    .from('items')
                    .update({ category: newName })
                    .eq('category', oldName);
                
                if (updateError) console.error('Error updating items category:', updateError);
                
                // Refresh data
                await loadCategories();
                await loadItems();
                displayCategoriesAdmin();
                displayStoreItems();
                displayItemsAdmin();
                
                alert(`Category updated from "${oldName}" to "${newName}"`);
            } catch (error) {
                console.error('Error updating category:', error);
                alert(`Error updating category: ${error.message}`);
            }
        }

        // Delete category
        async function deleteCategory(categoryId) {
            if(!confirm(`Delete this category? Items in this category will keep their category name.`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                // Refresh data
                await loadCategories();
                displayCategoriesAdmin();
                initializeCategoryDropdown();
                
                alert(`Category deleted successfully.`);
            } catch (error) {
                console.error('Error deleting category:', error);
                alert(`Error deleting category: ${error.message}`);
            }
        }

        // Load all data from Supabase
        async function loadAllData() {
            try {
                await Promise.all([
                    loadCategories(),
                    loadItems(),
                    loadOrders(),
                    loadUsers()
                ]);
                
                // Get the highest order number for counter
                if (orders.length > 0) {
                    orderCounter = Math.max(...orders.map(o => o.order_number || 0)) + 1;
                }
                
                // Initialize UI
                initializeCategoryDropdown();
                displayStoreItems();
                updateCartCount();
                updateHomeStats();
                updateStoreLink();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert(`Error loading data: ${error.message}`);
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                categories = data || [];
            } catch (error) {
                console.error('Error loading categories:', error);
                categories = [];
            }
        }

        // Load items
        async function loadItems() {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                items = data || [];
            } catch (error) {
                console.error('Error loading items:', error);
                items = [];
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (
                            item_id,
                            quantity,
                            items ( name, category )
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                orders = data || [];
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                users = data || [];
                displayUsersAdmin();
            } catch (error) {
                console.error('Error loading users:', error);
                users = [];
            }
        }

        // Display users in admin panel
        function displayUsersAdmin() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = '';
            
            if(users.length === 0) {
                userList.innerHTML = '<p>No registered users yet.</p>';
                return;
            }
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'item-card';
                userDiv.innerHTML = `
                    <h4>${user.full_name || 'N/A'}</h4>
                    <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                    <p><strong>User ID:</strong> ${user.user_id || 'N/A'}</p>
                    <p><strong>Shop ID:</strong> ${user.shop_id || 'N/A'}</p>
                    <p><strong>Contact:</strong> ${user.contact_number || 'N/A'}</p>
                    <p><strong>Region:</strong> ${user.region || 'N/A'}</p>
                    <p><strong>Registered:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                    <p><strong>Total Requests:</strong> ${user.total_requests || 0}</p>
                `;
                userList.appendChild(userDiv);
            });
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('#customerTabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if(tabName === 'store') {
                displayStoreItems();
            } else if(tabName === 'cart') {
                displayCart();
            } else if(tabName === 'orders') {
                displayCustomerOrders();
            } else if(tabName === 'home') {
                updateHomeStats();
            } else if(tabName === 'about') {
                updateStoreLink();
            } else if(tabName === 'track') {
                document.getElementById('trackingResult').style.display = 'none';
            } else if(tabName === 'checkout') {
                displayCheckoutSummary();
                // Set min date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('dateNeeded').min = tomorrow.toISOString().split('T')[0];
            }
        }

        // Display checkout summary
        function displayCheckoutSummary() {
            const checkoutSummary = document.getElementById('checkoutSummary');
            const checkoutSummaryTotal = document.getElementById('checkoutSummaryTotal');
            
            checkoutSummary.innerHTML = '';
            
            if(cart.length === 0) {
                checkoutSummary.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Your cart is empty. Add materials first.</p>';
                checkoutSummaryTotal.textContent = 'Total Items: 0';
                return;
            }
            
            cart.forEach(item => {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'summary-item';
                summaryDiv.innerHTML = `
                    <span>${item.name}</span>
                    <span>√ó ${item.quantity}</span>
                `;
                checkoutSummary.appendChild(summaryDiv);
            });
            
            checkoutSummaryTotal.textContent = `Total Items: ${cart.reduce((sum, item) => sum + item.quantity, 0)}`;
        }

        // Update home stats
        function updateHomeStats() {
            document.getElementById('homeTotalProducts').textContent = items.length;
            document.getElementById('homeTotalOrders').textContent = orders.length;
            document.getElementById('homeActiveOrders').textContent = orders.filter(o => o.status === 'processing' || o.status === 'shipped').length;
            document.getElementById('homeDeliveredOrders').textContent = orders.filter(o => o.status === 'delivered').length;
        }

        // Filter by category
        function filterCategory(category) {
            displayStoreItems();
        }

        // Display store items
        function displayStoreItems() {
            const storeItems = document.getElementById('storeItems');
            storeItems.innerHTML = '<div class="loading">Loading materials</div>';
            
            const categoryFilter = document.getElementById('categoryFilter').value;
            let filteredItems = categoryFilter === 'all' ? items : items.filter(item => item.category === categoryFilter);
            
            if(filteredItems.length === 0) {
                storeItems.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No materials available in this category.</p>';
                return;
            }
            
            storeItems.innerHTML = '';
            
            filteredItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-card';
                
                let stockClass = 'stock-high', stockText = 'In Stock';
                if(item.stock <= 0) {
                    stockClass = 'stock-low';
                    stockText = 'Out of Stock';
                } else if(item.stock < 10) {
                    stockClass = 'stock-medium';
                    stockText = 'Low Stock';
                }
                
                itemDiv.innerHTML = `
                    <h4>${item.name}</h4>
                    ${item.description ? `<p>${item.description}</p>` : ''}
                    <div>
                        <span class="category-tag">${item.category}</span>
                        <span class="stock-indicator ${stockClass}">${stockText}: ${item.stock}</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <input type="number" id="qty-${item.id}" min="1" max="${item.stock}" value="1" style="width: 80px; display: inline-block; margin-right: 10px;">
                        <button onclick="addToCart(${item.id})" ${item.stock === 0 ? 'disabled' : ''}>
                            ${item.stock === 0 ? 'Out of Stock' : 'üõí Add to Cart'}
                        </button>
                    </div>
                `;
                storeItems.appendChild(itemDiv);
            });
        }

        // Add to cart
        async function addToCart(itemId) {
            const item = items.find(i => i.id == itemId);
            const quantity = parseInt(document.getElementById(`qty-${itemId}`).value) || 1;
            
            if(item && item.stock >= quantity) {
                const cartItem = cart.find(ci => ci.itemId == itemId);
                
                if(cartItem) {
                    cartItem.quantity += quantity;
                } else {
                    cart.push({
                        itemId: item.id,
                        name: item.name,
                        category: item.category,
                        quantity: quantity
                    });
                }
                
                // Update stock in database
                try {
                    const { error } = await supabase
                        .from('items')
                        .update({ stock: item.stock - quantity })
                        .eq('id', item.id);
                    
                    if (error) throw error;
                    
                    // Update local items array
                    item.stock -= quantity;
                    
                    localStorage.setItem('infxCart', JSON.stringify(cart));
                    displayStoreItems();
                    updateCartCount();
                    alert(`Added ${quantity} √ó ${item.name} to cart!`);
                    document.getElementById(`qty-${itemId}`).value = 1;
                    
                } catch (error) {
                    console.error('Error updating stock:', error);
                    alert('Error adding to cart. Please try again.');
                }
            } else {
                alert('Not enough stock available!');
            }
        }

        // Update cart count
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = totalItems;
        }

        // Display cart
        function displayCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            cartItems.innerHTML = '';
            
            if(cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Your cart is empty.<br>Browse materials to add items!</p>';
                cartTotal.textContent = 'Total Items: 0';
                return;
            }
            
            cart.forEach((cartItem, index) => {
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'cart-item';
                cartItemDiv.innerHTML = `
                    <div>
                        <strong>${cartItem.name}</strong><br>
                        <span class="category-tag">${cartItem.category}</span>
                        <div>Quantity: ${cartItem.quantity}</div>
                    </div>
                    <div>
                        <button onclick="updateCartQuantity(${index}, ${cartItem.quantity - 1})">‚ûñ</button>
                        <button onclick="updateCartQuantity(${index}, ${cartItem.quantity + 1})">‚ûï</button>
                        <button class="cancel" onclick="removeFromCart(${index})">üóëÔ∏è</button>
                    </div>
                `;
                cartItems.appendChild(cartItemDiv);
            });
            
            cartTotal.textContent = `Total Items: ${cart.reduce((sum, item) => sum + item.quantity, 0)}`;
        }

        // Submit request
        async function submitRequest() {
            if(cart.length === 0) {
                alert('Your cart is empty! Please add materials first.');
                switchTab('store');
                return;
            }
            
            const requestorName = document.getElementById('requestorName').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const shopId = document.getElementById('shopId').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const address = document.getElementById('address').value.trim();
            const storeStatus = document.getElementById('storeStatus').value;
            const region = document.getElementById('region').value;
            const dateNeeded = document.getElementById('dateNeeded').value;
            const notes = document.getElementById('requestNotes').value.trim();
            
            if(!requestorName || !userId || !shopId || !contactNumber || !address || !storeStatus || !region || !dateNeeded) {
                alert('Please fill all required fields!');
                return;
            }
            
            const orderId = 'INFX' + orderCounter.toString().padStart(5, '0');
            
            try {
                // Create or update user
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .upsert({
                        user_id: userId,
                        shop_id: shopId,
                        full_name: requestorName,
                        contact_number: contactNumber,
                        region: region,
                        email: '', // Add email field if needed
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id',
                        ignoreDuplicates: false
                    })
                    .select();
                
                if (userError) throw userError;
                
                // Create order
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        order_id: orderId,
                        order_number: orderCounter,
                        requestor_name: requestorName,
                        user_id: userId,
                        shop_id: shopId,
                        contact_number: contactNumber,
                        address: address,
                        store_status: storeStatus,
                        region: region,
                        date_needed: dateNeeded,
                        notes: notes,
                        status: 'processing',
                        total_items: cart.reduce((sum, item) => sum + item.quantity, 0)
                    }])
                    .select();
                
                if (orderError) throw orderError;
                
                // Create order items
                const orderItems = cart.map(item => ({
                    order_id: orderId,
                    item_id: item.itemId,
                    quantity: item.quantity
                }));
                
                const { error: itemsError } = await supabase
                    .from('order_items')
                    .insert(orderItems);
                
                if (itemsError) throw itemsError;
                
                // Clear cart
                cart = [];
                localStorage.setItem('infxCart', JSON.stringify(cart));
                
                // Increment order counter
                orderCounter++;
                
                // Refresh data
                await loadAllData();
                displayCart();
                updateCartCount();
                
                // Clear form
                document.getElementById('requestorName').value = '';
                document.getElementById('userId').value = '';
                document.getElementById('shopId').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('address').value = '';
                document.getElementById('storeStatus').value = '';
                document.getElementById('region').value = '';
                document.getElementById('dateNeeded').value = '';
                document.getElementById('requestNotes').value = '';
                
                alert(`‚úÖ Material Request Submitted Successfully!\n\nRequest ID: ${orderId}\nName: ${requestorName}\nShop: ${shopId}\n\nSave your Request ID to track status!`);
                switchTab('orders');
                
            } catch (error) {
                console.error('Error submitting request:', error);
                alert(`Error submitting request: ${error.message}`);
            }
        }

        // Update cart quantity
        async function updateCartQuantity(index, newQuantity) {
            const cartItem = cart[index];
            const item = items.find(i => i.id == cartItem.itemId);
            
            if(item && newQuantity > 0) {
                const stockChange = newQuantity - cartItem.quantity;
                
                if(item.stock >= stockChange) {
                    cartItem.quantity = newQuantity;
                    
                    try {
                        const { error } = await supabase
                            .from('items')
                            .update({ stock: item.stock - stockChange })
                            .eq('id', item.id);
                        
                        if (error) throw error;
                        
                        item.stock -= stockChange;
                        localStorage.setItem('infxCart', JSON.stringify(cart));
                        displayCart();
                        displayStoreItems();
                        updateCartCount();
                        displayCheckoutSummary();
                        
                    } catch (error) {
                        console.error('Error updating quantity:', error);
                        alert('Error updating quantity. Please try again.');
                    }
                } else {
                    alert('Not enough stock available!');
                }
            } else if(newQuantity <= 0) {
                removeFromCart(index);
            }
        }

        // Remove from cart
        async function removeFromCart(index) {
            const cartItem = cart[index];
            const item = items.find(i => i.id == cartItem.itemId);
            
            if(item) {
                try {
                    const { error } = await supabase
                        .from('items')
                        .update({ stock: item.stock + cartItem.quantity })
                        .eq('id', item.id);
                    
                    if (error) throw error;
                    
                    item.stock += cartItem.quantity;
                    cart.splice(index, 1);
                    localStorage.setItem('infxCart', JSON.stringify(cart));
                    displayCart();
                    displayStoreItems();
                    updateCartCount();
                    displayCheckoutSummary();
                    
                } catch (error) {
                    console.error('Error removing from cart:', error);
                    alert('Error removing item from cart. Please try again.');
                }
            }
        }

        // Clear cart
        async function clearCart() {
            if(cart.length === 0) return;
            
            if(confirm('Clear your cart?')) {
                try {
                    // Restore stock for all items in cart
                    const updates = cart.map(cartItem => {
                        const item = items.find(i => i.id == cartItem.itemId);
                        if(item) {
                            return supabase
                                .from('items')
                                .update({ stock: item.stock + cartItem.quantity })
                                .eq('id', item.id);
                        }
                        return null;
                    }).filter(update => update !== null);
                    
                    await Promise.all(updates);
                    
                    // Update local items array
                    cart.forEach(cartItem => {
                        const item = items.find(i => i.id == cartItem.itemId);
                        if(item) item.stock += cartItem.quantity;
                    });
                    
                    cart = [];
                    localStorage.setItem('infxCart', JSON.stringify(cart));
                    displayCart();
                    displayStoreItems();
                    updateCartCount();
                    displayCheckoutSummary();
                    
                } catch (error) {
                    console.error('Error clearing cart:', error);
                    alert('Error clearing cart. Please try again.');
                }
            }
        }

        // Display customer orders
        async function displayCustomerOrders() {
            const customerOrders = document.getElementById('customerOrders');
            customerOrders.innerHTML = '<div class="loading">Loading your requests</div>';
            
            try {
                await loadOrders();
                
                if(orders.length === 0) {
                    customerOrders.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No requests yet.<br>Your requests will appear here!</p>';
                    return;
                }
                
                customerOrders.innerHTML = '';
                
                orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-card';
                    
                    // Format order items
                    const itemsText = order.order_items 
                        ? order.order_items.map(oi => 
                            `${oi.items?.name || 'Item'} √ó ${oi.quantity}`
                          ).join(', ')
                        : 'No items';
                    
                    orderDiv.innerHTML = `
                        <div class="order-id">${order.order_id}</div>
                        <p><strong>Requestor:</strong> ${order.requestor_name} (ID: ${order.user_id})</p>
                        <p><strong>Shop:</strong> ${order.shop_id} ‚Ä¢ ${order.store_status} ‚Ä¢ ${order.region}</p>
                        <p><strong>Contact:</strong> ${order.contact_number}</p>
                        <p><strong>Address:</strong> ${order.address}</p>
                        <p><strong>Date Needed:</strong> ${order.date_needed}</p>
                        <p><strong>Date Requested:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        <p><strong>Materials:</strong> ${itemsText}</p>
                        <p><strong>Status:</strong> <span class="status ${order.status}">${order.status.toUpperCase()}</span></p>
                        ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                        <button onclick="viewOrderDetails('${order.order_id}')">üìã View Details</button>
                        <button onclick="trackSpecificOrder('${order.order_id}')">üìç Track Request</button>
                        ${order.status === 'processing' ? `<button class="cancel" onclick="cancelOrder('${order.order_id}')">‚ùå Cancel Request</button>` : ''}
                    `;
                    customerOrders.appendChild(orderDiv);
                });
                
            } catch (error) {
                console.error('Error loading orders:', error);
                customerOrders.innerHTML = `<div class="error">Error loading orders: ${error.message}</div>`;
            }
        }

        // Track specific order
        function trackSpecificOrder(orderId) {
            switchTab('track');
            document.getElementById('trackOrderId').value = orderId;
            setTimeout(() => trackOrder(), 100);
        }

        // Track order
        async function trackOrder() {
            const orderId = document.getElementById('trackOrderId').value.trim().toUpperCase();
            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');
            
            if(!orderId) {
                alert('Please enter a Request ID');
                return;
            }
            
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (
                            quantity,
                            items ( name )
                        )
                    `)
                    .eq('order_id', orderId)
                    .single();
                
                if(error || !order) {
                    detailsDiv.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 20px;">
                            <h3>‚ùå Request Not Found</h3>
                            <p>Request ID "${orderId}" was not found.</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    return;
                }
                
                // Update progress tracker
                const steps = document.querySelectorAll('.tracker-step');
                const statusIndex = {
                    'processing': 1,
                    'shipped': 2,
                    'delivered': 3,
                    'cancelled': -1
                };
                
                steps.forEach((step, index) => {
                    const circle = step.querySelector('.step-circle');
                    const label = step.querySelector('.step-label');
                    
                    if(index <= statusIndex[order.status]) {
                        circle.classList.add('active');
                        label.classList.add('active');
                    } else {
                        circle.classList.remove('active');
                        label.classList.remove('active');
                    }
                });
                
                if(order.status === 'cancelled') {
                    steps.forEach(step => {
                        step.querySelector('.step-circle').classList.remove('active');
                        step.querySelector('.step-label').classList.remove('active');
                    });
                }
                
                // Format order items
                const itemsText = order.order_items 
                    ? order.order_items.map(oi => 
                        `${oi.items?.name || 'Item'} √ó ${oi.quantity}`
                      ).join(', ')
                    : 'No items';
                
                detailsDiv.innerHTML = `
                    <h3>üì¶ Request Tracking: ${order.order_id}</h3>
                    <p><strong>Requestor:</strong> ${order.requestor_name}</p>
                    <p><strong>Shop ID:</strong> ${order.shop_id} (${order.store_status}, ${order.region})</p>
                    <p><strong>Contact:</strong> ${order.contact_number}</p>
                    <p><strong>Address:</strong> ${order.address}</p>
                    <p><strong>Date Needed:</strong> ${order.date_needed}</p>
                    <p><strong>Request Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                    <p><strong>Current Status:</strong> <span class="status ${order.status}">${order.status.toUpperCase()}</span></p>
                    <p><strong>Materials:</strong> ${itemsText}</p>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    ${order.status === 'cancelled' ? 
                        '<div style="background: #fde8e8; padding: 15px; border-radius: 8px; margin-top: 15px;"><strong>‚ö†Ô∏è This request has been cancelled.</strong></div>' : ''}
                `;
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                console.error('Error tracking order:', error);
                detailsDiv.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 20px;">
                        <h3>‚ùå Error Tracking Request</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (
                            quantity,
                            items ( name, category )
                        )
                    `)
                    .eq('order_id', orderId)
                    .single();
                
                if(error) throw error;
                
                const itemsText = order.order_items 
                    ? order.order_items.map(oi => 
                        `  ‚Ä¢ ${oi.items?.name || 'Item'} x${oi.quantity} (${oi.items?.category || ''})`
                      ).join('\n')
                    : '  ‚Ä¢ No items';
                
                alert(`üìã REQUEST DETAILS\n
Request ID: ${order.order_id}
Requestor: ${order.requestor_name}
User ID: ${order.user_id}
Shop ID: ${order.shop_id}
Contact Number: ${order.contact_number}
Address: ${order.address}
Store Status: ${order.store_status}
Region: ${order.region}
Date Needed: ${order.date_needed}
Request Date: ${new Date(order.created_at).toLocaleString()}
Status: ${order.status.toUpperCase()}
${order.notes ? `Notes: ${order.notes}\n` : ''}
MATERIALS:
${itemsText}

Total Items: ${order.total_items || 0}`);
                
            } catch (error) {
                console.error('Error viewing order details:', error);
                alert('Error loading order details. Please try again.');
            }
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if(!confirm('Are you sure you want to cancel this request?')) {
                return;
            }
            
            try {
                // Get order details
                const { data: order, error: fetchError } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (
                            item_id,
                            quantity
                        )
                    `)
                    .eq('order_id', orderId)
                    .eq('status', 'processing')
                    .single();
                
                if(fetchError || !order) {
                    alert('Order not found or cannot be cancelled.');
                    return;
                }
                
                // Restore stock for all items
                const updates = order.order_items.map(oi => 
                    supabase.rpc('increment_stock', {
                        item_id: oi.item_id,
                        increment: oi.quantity
                    })
                );
                
                await Promise.all(updates);
                
                // Update order status
                const { error: updateError } = await supabase
                    .from('orders')
                    .update({ status: 'cancelled' })
                    .eq('order_id', orderId);
                
                if(updateError) throw updateError;
                
                // Refresh data
                await loadAllData();
                alert('Request cancelled successfully.');
                
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Error cancelling request. Please try again.');
            }
        }

        // Search orders
        function searchOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const orderDivs = document.querySelectorAll('#customerOrders .order-card');
            
            orderDivs.forEach(div => {
                const text = div.textContent.toLowerCase();
                div.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Admin functions
        function showAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'block';
        }

        function hideAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if(password === ADMIN_PASSWORD) {
                document.getElementById('adminContent').style.display = 'block';
                displayItemsAdmin();
                displayOrdersAdmin();
                displayCategoriesAdmin();
                loadUsers();
                document.getElementById('adminPassword').value = '';
            } else {
                alert('Incorrect password!');
            }
        }

        // Admin Tab Switching
        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('admin-' + tabName + '-tab').classList.add('active');
            
            if(tabName === 'users') {
                loadUsers();
            }
        }

        // Add item
        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const stock = parseInt(document.getElementById('itemStock').value);
            const desc = document.getElementById('itemDesc').value.trim();
            
            if(!name || !category || isNaN(stock) || stock < 0) {
                alert('Please fill all required fields correctly!');
                return;
            }
            
            try {
                // Find category ID
                const categoryId = categories.find(c => c.name === category)?.id;
                
                const { data, error } = await supabase
                    .from('items')
                    .insert([{
                        name: name,
                        category: category,
                        category_id: categoryId,
                        stock: stock,
                        description: desc
                    }])
                    .select();
                
                if(error) throw error;
                
                // Refresh items
                await loadItems();
                displayItemsAdmin();
                displayStoreItems();
                
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemStock').value = '';
                document.getElementById('itemDesc').value = '';
                
                alert('Material added successfully!');
                
            } catch (error) {
                console.error('Error adding item:', error);
                alert(`Error adding material: ${error.message}`);
            }
        }

        // Display items in admin panel
        async function displayItemsAdmin() {
            const stockList = document.getElementById('stockList');
            stockList.innerHTML = '<div class="loading">Loading materials</div>';
            
            try {
                await loadItems();
                
                stockList.innerHTML = '';
                
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-card';
                    itemDiv.innerHTML = `
                        <h4>${item.name} <span class="category-tag">${item.category}</span></h4>
                        ${item.description ? `<p>${item.description}</p>` : ''}
                        <p>Stock: <span class="${item.stock < 10 ? 'stock-low' : 'stock-high'}">${item.stock} units</span></p>
                        <div style="margin-top: 15px;">
                            <select id="cat-${item.id}" style="width: auto; margin-right: 10px;">
                                ${categories.map(cat => 
                                    `<option value="${cat.name}" ${item.category === cat.name ? 'selected' : ''}>${cat.name}</option>`
                                ).join('')}
                            </select>
                            <button onclick="updateItemCategory(${item.id})">Update Category</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="updateStock(${item.id}, 10)">+10</button>
                            <button onclick="updateStock(${item.id}, 5)">+5</button>
                            <button onclick="updateStock(${item.id}, -1)">-1</button>
                            <button onclick="updateStock(${item.id}, -5)">-5</button>
                            <button class="cancel" onclick="deleteItem(${item.id})">Delete Material</button>
                        </div>
                    `;
                    stockList.appendChild(itemDiv);
                });
            } catch (error) {
                console.error('Error loading items:', error);
                stockList.innerHTML = `<div class="error">Error loading materials: ${error.message}</div>`;
            }
        }

        // Update item category
        async function updateItemCategory(itemId) {
            const item = items.find(i => i.id == itemId);
            if(item) {
                const select = document.getElementById(`cat-${itemId}`);
                const newCategory = select.value;
                
                try {
                    const { error } = await supabase
                        .from('items')
                        .update({ category: newCategory })
                        .eq('id', itemId);
                    
                    if(error) throw error;
                    
                    // Update local item
                    item.category = newCategory;
                    
                    displayItemsAdmin();
                    displayStoreItems();
                    
                    alert(`Category updated to "${newCategory}"`);
                    
                } catch (error) {
                    console.error('Error updating category:', error);
                    alert(`Error updating category: ${error.message}`);
                }
            }
        }

        // Update stock
        async function updateStock(itemId, change) {
            const item = items.find(i => i.id == itemId);
            if(item) {
                const newStock = item.stock + change;
                if(newStock >= 0) {
                    try {
                        const { error } = await supabase
                            .from('items')
                            .update({ stock: newStock })
                            .eq('id', itemId);
                        
                        if(error) throw error;
                        
                        // Update local item
                        item.stock = newStock;
                        
                        displayItemsAdmin();
                        displayStoreItems();
                        
                    } catch (error) {
                        console.error('Error updating stock:', error);
                        alert(`Error updating stock: ${error.message}`);
                    }
                }
            }
        }

        // Delete item
        async function deleteItem(itemId) {
            if(!confirm('Delete this material?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('items')
                    .delete()
                    .eq('id', itemId);
                
                if(error) throw error;
                
                // Refresh items
                await loadItems();
                displayItemsAdmin();
                displayStoreItems();
                
            } catch (error) {
                console.error('Error deleting item:', error);
                alert(`Error deleting material: ${error.message}`);
            }
        }

        // Display orders in admin panel
        async function displayOrdersAdmin() {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '<div class="loading">Loading requests</div>';
            
            try {
                await loadOrders();
                
                orderList.innerHTML = '';
                
                if(orders.length === 0) {
                    orderList.innerHTML = '<p>No requests yet.</p>';
                    return;
                }
                
                orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-card';
                    
                    // Format order items
                    const itemsText = order.order_items 
                        ? order.order_items.map(oi => 
                            `${oi.items?.name || 'Item'} (x${oi.quantity})`
                          ).join(', ')
                        : 'No items';
                    
                    orderDiv.innerHTML = `
                        <h4><span class="order-id">${order.order_id}</span> - ${order.requestor_name}</h4>
                        <p><strong>Shop:</strong> ${order.shop_id} ‚Ä¢ ${order.region} ‚Ä¢ ${order.store_status}</p>
                        <p><strong>Contact:</strong> ${order.contact_number}</p>
                        <p><strong>Address:</strong> ${order.address}</p>
                        <p><strong>Date Needed:</strong> ${order.date_needed}</p>
                        <p><strong>Date Requested:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        <p><strong>Materials:</strong> ${itemsText}</p>
                        <p><strong>Total Items:</strong> ${order.total_items || 0}</p>
                        ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                        <p><strong>Status:</strong> 
                            <span class="status ${order.status}">${order.status.toUpperCase()}</span>
                            <select onchange="updateOrderStatus('${order.order_id}', this.value)" style="margin-left: 10px; padding: 8px; border-radius: 6px; border: 2px solid #ddd;">
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Approved</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </p>
                        <button onclick="viewOrderDetails('${order.order_id}')">View Details</button>
                    `;
                    orderList.appendChild(orderDiv);
                });
                
            } catch (error) {
                console.error('Error loading orders:', error);
                orderList.innerHTML = `<div class="error">Error loading requests: ${error.message}</div>`;
            }
        }

        function searchAdminOrders() {
            const searchTerm = document.getElementById('adminOrderSearch').value.toLowerCase();
            const orderDivs = document.querySelectorAll('#orderList .order-card');
            
            orderDivs.forEach(div => {
                const text = div.textContent.toLowerCase();
                div.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const order = orders.find(o => o.order_id === orderId);
                if(!order) {
                    alert('Order not found');
                    return;
                }
                
                const oldStatus = order.status;
                
                // Update order status
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('order_id', orderId);
                
                if(error) throw error;
                
                // If cancelling, restore stock
                if(newStatus === 'cancelled' && oldStatus !== 'cancelled') {
                    // Get order items
                    const { data: orderItems, error: itemsError } = await supabase
                        .from('order_items')
                        .select('item_id, quantity')
                        .eq('order_id', orderId);
                    
                    if(itemsError) throw itemsError;
                    
                    // Restore stock for each item
                    const updates = orderItems.map(oi => 
                        supabase.rpc('increment_stock', {
                            item_id: oi.item_id,
                            increment: oi.quantity
                        })
                    );
                    
                    await Promise.all(updates);
                }
                
                // Refresh data
                await loadAllData();
                displayOrdersAdmin();
                displayCustomerOrders();
                
            } catch (error) {
                console.error('Error updating order status:', error);
                alert(`Error updating status: ${error.message}`);
            }
        }

        // Export functions
        async function exportToExcel(dataType) {
            try {
                let data, filename, worksheetName;
                
                if(dataType === 'items') {
                    const { data: itemsData, error } = await supabase
                        .from('items')
                        .select('*');
                    
                    if(error) throw error;
                    
                    data = itemsData.map(item => ({
                        'ID': item.id,
                        'Material Name': item.name,
                        'Category': item.category,
                        'Stock': item.stock,
                        'Description': item.description || '',
                        'Created At': new Date(item.created_at).toLocaleString()
                    }));
                    filename = 'infx_materials_export.xls';
                    worksheetName = 'Materials';
                } else if(dataType === 'orders') {
                    const { data: ordersData, error } = await supabase
                        .from('orders')
                        .select(`
                            *,
                            order_items (
                                quantity,
                                items ( name )
                            )
                        `);
                    
                    if(error) throw error;
                    
                    data = ordersData.map(order => ({
                        'Request ID': order.order_id,
                        'Requestor Name': order.requestor_name,
                        'User ID': order.user_id,
                        'Shop ID': order.shop_id,
                        'Contact Number': order.contact_number,
                        'Address': order.address,
                        'Store Status': order.store_status,
                        'Region': order.region,
                        'Date Needed': order.date_needed,
                        'Request Date': new Date(order.created_at).toLocaleString(),
                        'Status': order.status,
                        'Notes': order.notes || '',
                        'Total Items': order.total_items,
                        'Materials': order.order_items 
                            ? order.order_items.map(oi => `${oi.items?.name || 'Item'} (x${oi.quantity})`).join('; ')
                            : ''
                    }));
                    filename = 'infx_requests_export.xls';
                    worksheetName = 'Requests';
                }
                
                if(!data || data.length === 0) {
                    alert('No data to export!');
                    return;
                }
                
                const headers = Object.keys(data[0]);
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                          xmlns:x="urn:schemas-microsoft-com:office:excel" 
                          xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="UTF-8">
                        <title>${worksheetName}</title>
                        <style>
                            td { padding: 5px; border: 1px solid #ddd; }
                            th { background: var(--main-green); color: white; padding: 10px; border: 1px solid #ddd; }
                        </style>
                    </head>
                    <body>
                        <table>
                            <thead><tr>
                `;
                
                headers.forEach(header => html += `<th>${header}</th>`);
                html += `</tr></thead><tbody>`;
                
                data.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => html += `<td>${row[header] || ''}</td>`);
                    html += '</tr>';
                });
                
                html += `</tbody></table></body></html>`;
                
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Data exported as ${filename}!`);
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert(`Error exporting data: ${error.message}`);
            }
        }

        async function backupData() {
            try {
                // Get all data
                const [itemsRes, ordersRes, categoriesRes, usersRes] = await Promise.all([
                    supabase.from('items').select('*'),
                    supabase.from('orders').select('*'),
                    supabase.from('categories').select('*'),
                    supabase.from('users').select('*')
                ]);
                
                if(itemsRes.error) throw itemsRes.error;
                if(ordersRes.error) throw ordersRes.error;
                if(categoriesRes.error) throw categoriesRes.error;
                if(usersRes.error) throw usersRes.error;
                
                const backup = {
                    items: itemsRes.data,
                    orders: ordersRes.data,
                    categories: categoriesRes.data,
                    users: usersRes.data,
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', `infx_backup_${new Date().toISOString().split('T')[0]}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Backup created successfully!');
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert(`Error creating backup: ${error.message}`);
            }
        }

        // Share functions
        function updateStoreLink() {
            const link = window.location.href.split('?')[0];
            document.getElementById('storeLink').value = link;
        }

        function copyStoreLink() {
            const linkInput = document.getElementById('storeLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(linkInput.value);
            alert('System link copied to clipboard!');
        }

        // Initialize
        window.onload = async function() {
            try {
                // Initialize Supabase connection
                const { data, error } = await supabase.from('items').select('*').limit(1);
                
                if(error) {
                    console.error('Supabase connection error:', error);
                    alert('Warning: Could not connect to database. Some features may not work.');
                }
                
                // Load all data
                await loadAllData();
                
                // Check if we need to insert default data
                if(items.length === 0) {
                    const confirmInsert = confirm('No materials found. Would you like to insert sample data?');
                    if(confirmInsert) {
                        await insertSampleData();
                        await loadAllData();
                    }
                }
                
                updateCartCount();
                updateStoreLink();
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing system. Please check your Supabase configuration.');
            }
        };

        // Insert sample data
        async function insertSampleData() {
            try {
                // Insert categories
                const defaultCategories = [
                    "Marketing Materials",
                    "Display Units",
                    "POS Materials",
                    "Branding Items",
                    "Promotional Tools",
                    "Equipment",
                    "Stationery"
                ];
                
                for (const categoryName of defaultCategories) {
                    await supabase
                        .from('categories')
                        .insert([{ name: categoryName }])
                        .onConflict('name')
                        .ignore();
                }
                
                // Insert sample items
                const sampleItems = [
                    { name: "Infinix Branded T-Shirts", category: "Marketing Materials", stock: 50, description: "Various sizes available" },
                    { name: "Counter Display Unit", category: "Display Units", stock: 10, description: "Floor standing display" },
                    { name: "Poster Set", category: "POS Materials", stock: 100, description: "Set of 5 promotional posters" },
                    { name: "Branded Pens", category: "Stationery", stock: 200, description: "Infinix logo pens" },
                    { name: "Promotional Flyers", category: "Marketing Materials", stock: 500, description: "A4 size, full color" },
                    { name: "Banner Stand", category: "Display Units", stock: 15, description: "Roll-up banner" },
                    { name: "Price Cards", category: "POS Materials", stock: 300, description: "Cardstock price displays" }
                ];
                
                for (const item of sampleItems) {
                    await supabase
                        .from('items')
                        .insert([item]);
                }
                
                alert('Sample data inserted successfully!');
                
            } catch (error) {
                console.error('Error inserting sample data:', error);
                alert(`Error inserting sample data: ${error.message}`);
            }
        }
    </script>
</body>
</html>

