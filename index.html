<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINIX | BTL Material Management System</title>
    
    <!-- Add Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Your existing CSS styles remain exactly the same */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        :root {
            --dark-green: #11270B;
            --main-green: #71B340;
            --light-green: #669D31;
            --accent-green: #598B2C;
            --deep-green: #3C5A14;
        }
        /* ... (ALL YOUR EXISTING CSS STYLES REMAIN UNCHANGED) ... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains exactly the same -->
    <div class="header">
        <h1><span class="logo">INFINIX</span> | BTL Material Management System</h1>
        <p>Efficient Material Request & Tracking System</p>
    </div>

    <!-- BANNER -->
    <div class="banner-container">
        <div class="banner-scroll">
            <span>Together We Grow. Together We Win. Infinix 2026!</span>
            <span>BTL Material Management System</span>
            <span>Efficient ‚Ä¢ Organized ‚Ä¢ Professional</span>
        </div>
    </div>

    <!-- CUSTOMER TABS -->
    <div class="tab-buttons" id="customerTabs">
        <button class="tab-btn active" onclick="switchTab('home')">üè† Home</button>
        <button class="tab-btn" onclick="switchTab('store')">üõçÔ∏è Materials</button>
        <button class="tab-btn" onclick="switchTab('cart')">üõí Cart (<span id="cartCount">0</span>)</button>
        <button class="tab-btn" onclick="switchTab('checkout')">üìù Submit Request</button>
        <button class="tab-btn" onclick="switchTab('orders')">üì¶ My Requests</button>
        <button class="tab-btn" onclick="switchTab('track')">üìç Track Request</button>
        <button class="tab-btn" onclick="switchTab('about')">üë• About</button>
    </div>

    <!-- All your existing tab content remains exactly the same -->
    <!-- ... (HOME, STORE, CART, CHECKOUT, ORDERS, TRACK, ABOUT tabs) ... -->

    <!-- ADMIN PANEL -->
    <div class="admin-key" onclick="showAdminPanel()">
        <span>üîë</span>
        <span>Admin Panel</span>
    </div>
    
    <div class="admin-overlay" id="adminOverlay" onclick="hideAdminPanel()"></div>
    
    <div class="admin-panel" id="adminPanel">
        <!-- Admin panel content remains exactly the same -->
    </div>

    <script>
        // ==============================================
        // SUPABASE CONFIGURATION
        // ==============================================
        // REPLACE THESE WITH YOUR SUPABASE PROJECT CREDENTIALS
        const SUPABASE_URL = 'https://qmmxtglgizvqilmzneqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbXh0Z2xnaXp2cWlsbXpuZXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTksImV4cCI6MjA4MDMzNDAxOX0.fpogdv4U0pbWKUPKIUTigIxtannvWOwdY6PnJtebudU';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==============================================
        // DATA STORAGE (with Supabase integration)
        // ==============================================
        let items = [];
        let cart = JSON.parse(localStorage.getItem('infxCart')) || [];
        let categories = [];
        let orders = [];
        let orderCounter = 1;
        const ADMIN_PASSWORD = "INFINIXBTL123";

        // ==============================================
        // SUPABASE FUNCTIONS
        // ==============================================

        // Load items from Supabase
        async function loadItemsFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                items = data || [];
                return items;
            } catch (error) {
                console.error('Error loading items:', error);
                alert('Error loading materials. Using local data.');
                return getLocalItems();
            }
        }

        // Load categories from Supabase
        async function loadCategoriesFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                categories = data.map(cat => cat.name) || [];
                return categories;
            } catch (error) {
                console.error('Error loading categories:', error);
                return getLocalCategories();
            }
        }

        // Load orders from Supabase
        async function loadOrdersFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        order_items (*)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Transform Supabase data to match our format
                orders = (data || []).map(order => ({
                    id: order.order_id,
                    requestorName: order.requestor_name,
                    userId: order.user_id,
                    shopId: order.shop_id,
                    contactNumber: order.contact_number,
                    address: order.address,
                    storeStatus: order.store_status,
                    region: order.region,
                    dateNeeded: order.date_needed,
                    notes: order.notes,
                    status: order.status,
                    date: new Date(order.created_at).toLocaleString(),
                    items: order.order_items.map(oi => ({
                        itemId: oi.item_id,
                        name: oi.item_name,
                        quantity: oi.quantity
                    })),
                    orderNumber: parseInt(order.order_id.replace('INFX', ''))
                }));
                
                return orders;
            } catch (error) {
                console.error('Error loading orders:', error);
                return getLocalOrders();
            }
        }

        // Get next order ID from Supabase
        async function getNextOrderId() {
            try {
                // Get current counter value
                const { data: counterData, error: counterError } = await supabase
                    .from('system_counters')
                    .select('value')
                    .eq('name', 'order_counter')
                    .single();
                
                if (counterError) throw counterError;
                
                const currentValue = counterData.value;
                const orderId = 'INFX' + currentValue.toString().padStart(5, '0');
                
                // Increment counter
                const { error: updateError } = await supabase
                    .from('system_counters')
                    .update({ value: currentValue + 1 })
                    .eq('name', 'order_counter');
                
                if (updateError) throw updateError;
                
                return orderId;
            } catch (error) {
                console.error('Error getting order ID:', error);
                // Fallback to local counter
                const orderId = 'INFX' + orderCounter.toString().padStart(5, '0');
                orderCounter++;
                localStorage.setItem('infxOrderCounter', orderCounter.toString());
                return orderId;
            }
        }

        // Submit order to Supabase
        async function submitOrderToSupabase(orderData) {
            try {
                // 1. Insert order
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        order_id: orderData.id,
                        requestor_name: orderData.requestorName,
                        user_id: orderData.userId,
                        shop_id: orderData.shopId,
                        contact_number: orderData.contactNumber,
                        address: orderData.address,
                        store_status: orderData.storeStatus,
                        region: orderData.region,
                        date_needed: orderData.dateNeeded,
                        notes: orderData.notes,
                        status: orderData.status
                    }])
                    .select()
                    .single();
                
                if (orderError) throw orderError;
                
                // 2. Insert order items
                const orderItems = orderData.items.map(item => ({
                    order_id: orderData.id,
                    item_id: item.itemId,
                    item_name: item.name,
                    quantity: item.quantity
                }));
                
                const { error: itemsError } = await supabase
                    .from('order_items')
                    .insert(orderItems);
                
                if (itemsError) throw itemsError;
                
                // 3. Update item stock in database
                for (const item of orderData.items) {
                    const currentItem = items.find(i => i.id === item.itemId);
                    if (currentItem) {
                        const newStock = currentItem.stock - item.quantity;
                        await updateItemStock(item.itemId, newStock);
                    }
                }
                
                return { success: true, orderId: orderData.id };
            } catch (error) {
                console.error('Error submitting order:', error);
                return { success: false, error: error.message };
            }
        }

        // Update item stock in Supabase
        async function updateItemStock(itemId, newStock) {
            try {
                const { error } = await supabase
                    .from('items')
                    .update({ stock: newStock })
                    .eq('id', itemId);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error updating stock:', error);
                return false;
            }
        }

        // Admin: Add new item to Supabase
        async function addItemToSupabase(itemData) {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .insert([{
                        name: itemData.name,
                        category: itemData.category,
                        stock: itemData.stock,
                        description: itemData.description
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error adding item:', error);
                throw error;
            }
        }

        // Admin: Add new category to Supabase
        async function addCategoryToSupabase(categoryName) {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .insert([{ name: categoryName }])
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error adding category:', error);
                throw error;
            }
        }

        // Admin: Update order status in Supabase
        async function updateOrderStatusInSupabase(orderId, newStatus) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('order_id', orderId);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error updating order status:', error);
                return false;
            }
        }

        // ==============================================
        // FALLBACK LOCAL FUNCTIONS
        // ==============================================

        function getLocalItems() {
            const localItems = JSON.parse(localStorage.getItem('infxItems'));
            if (localItems && localItems.length > 0) {
                return localItems;
            }
            return [
                { id: 1, name: "Infinix Branded T-Shirts", category: "Marketing Materials", stock: 50, description: "Various sizes available" },
                { id: 2, name: "Counter Display Unit", category: "Display Units", stock: 10, description: "Floor standing display" },
                { id: 3, name: "Poster Set", category: "POS Materials", stock: 100, description: "Set of 5 promotional posters" },
                { id: 4, name: "Branded Pens", category: "Stationery", stock: 200, description: "Infinix logo pens" },
                { id: 5, name: "Promotional Flyers", category: "Marketing Materials", stock: 500, description: "A4 size, full color" },
                { id: 6, name: "Banner Stand", category: "Display Units", stock: 15, description: "Roll-up banner" },
                { id: 7, name: "Price Cards", category: "POS Materials", stock: 300, description: "Cardstock price displays" }
            ];
        }

        function getLocalCategories() {
            const localCats = JSON.parse(localStorage.getItem('infxCategories'));
            if (localCats && localCats.length > 0) {
                return localCats;
            }
            return [
                "Marketing Materials",
                "Display Units",
                "POS Materials",
                "Branding Items",
                "Promotional Tools",
                "Equipment",
                "Stationery"
            ];
        }

        function getLocalOrders() {
            return JSON.parse(localStorage.getItem('infxOrders')) || [];
        }

        // ==============================================
        // MODIFIED MAIN FUNCTIONS FOR SUPABASE
        // ==============================================

        // Initialize app
        async function initializeApp() {
            try {
                // Show loading state
                document.getElementById('storeItems').innerHTML = '<p style="text-align: center; padding: 40px;">Loading materials...</p>';
                
                // Load data from Supabase
                await Promise.all([
                    loadItemsFromSupabase(),
                    loadCategoriesFromSupabase(),
                    loadOrdersFromSupabase()
                ]);
                
                // Initialize UI
                initializeCategoryDropdown();
                displayStoreItems();
                updateCartCount();
                displayCategoriesAdmin();
                updateStoreLink();
                updateHomeStats();
                
                // Save data locally as backup
                saveLocalData();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback to local data
                items = getLocalItems();
                categories = getLocalCategories();
                orders = getLocalOrders();
                orderCounter = parseInt(localStorage.getItem('infxOrderCounter')) || 1;
                
                initializeCategoryDropdown();
                displayStoreItems();
                updateCartCount();
                displayCategoriesAdmin();
                updateStoreLink();
                updateHomeStats();
            }
        }

        // Submit request (updated for Supabase)
        async function submitRequest() {
            if(cart.length === 0) {
                alert('Your cart is empty! Please add materials first.');
                switchTab('store');
                return;
            }
            
            const requestorName = document.getElementById('requestorName').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const shopId = document.getElementById('shopId').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const address = document.getElementById('address').value.trim();
            const storeStatus = document.getElementById('storeStatus').value;
            const region = document.getElementById('region').value;
            const dateNeeded = document.getElementById('dateNeeded').value;
            const notes = document.getElementById('requestNotes').value.trim();
            
            if(!requestorName || !userId || !shopId || !contactNumber || !address || !storeStatus || !region || !dateNeeded) {
                alert('Please fill all required fields!');
                return;
            }
            
            // Get order ID from Supabase
            const orderId = await getNextOrderId();
            
            const orderData = {
                id: orderId,
                requestorName: requestorName,
                userId: userId,
                shopId: shopId,
                contactNumber: contactNumber,
                address: address,
                storeStatus: storeStatus,
                region: region,
                dateNeeded: dateNeeded,
                notes: notes,
                date: new Date().toLocaleString(),
                items: [...cart],
                status: 'processing'
            };
            
            // Submit to Supabase
            const result = await submitOrderToSupabase(orderData);
            
            if (result.success) {
                // Add to local orders array
                orders.push(orderData);
                
                // Clear cart
                cart = [];
                localStorage.setItem('infxCart', JSON.stringify(cart));
                
                // Update UI
                displayCart();
                updateCartCount();
                displayCustomerOrders();
                displayStoreItems(); // Refresh to show updated stock
                
                // Clear form
                document.getElementById('requestorName').value = '';
                document.getElementById('userId').value = '';
                document.getElementById('shopId').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('address').value = '';
                document.getElementById('storeStatus').value = '';
                document.getElementById('region').value = '';
                document.getElementById('dateNeeded').value = '';
                document.getElementById('requestNotes').value = '';
                
                alert(`‚úÖ Material Request Submitted Successfully!\n\nRequest ID: ${orderId}\nName: ${requestorName}\nShop: ${shopId}\n\nSave your Request ID to track status!`);
                switchTab('orders');
            } else {
                alert(`Error submitting request: ${result.error}\n\nPlease try again or contact support.`);
            }
        }

        // Update order status (for admin)
        async function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if(order) {
                const oldStatus = order.status;
                order.status = newStatus;
                
                // Update in Supabase
                const success = await updateOrderStatusInSupabase(orderId, newStatus);
                
                if (success) {
                    // Update local items stock if cancelled
                    if(newStatus === 'cancelled' && oldStatus !== 'cancelled') {
                        for (const orderItem of order.items) {
                            const item = items.find(i => i.id == orderItem.itemId);
                            if(item) {
                                item.stock += orderItem.quantity;
                                await updateItemStock(item.id, item.stock);
                            }
                        }
                    }
                    
                    saveLocalData();
                    displayOrdersAdmin();
                    displayCustomerOrders();
                    displayStoreItems();
                } else {
                    alert('Error updating order status in database');
                }
            }
        }

        // Admin: Add item
        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const stock = parseInt(document.getElementById('itemStock').value);
            const desc = document.getElementById('itemDesc').value.trim();
            
            if(!name || !category || isNaN(stock) || stock < 0) {
                alert('Please fill all required fields correctly!');
                return;
            }
            
            try {
                const newItem = await addItemToSupabase({
                    name: name,
                    category: category,
                    stock: stock,
                    description: desc
                });
                
                // Add to local items array
                items.push({
                    id: newItem.id,
                    name: newItem.name,
                    category: newItem.category,
                    stock: newItem.stock,
                    description: newItem.description
                });
                
                saveLocalData();
                displayItemsAdmin();
                displayStoreItems();
                
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemStock').value = '';
                document.getElementById('itemDesc').value = '';
                
                alert('Material added successfully to database!');
            } catch (error) {
                console.error('Error adding item:', error);
                alert('Error adding material to database. Added locally instead.');
                
                // Fallback to local storage
                const newItem = {
                    id: Date.now(),
                    name: name,
                    category: category,
                    stock: stock,
                    description: desc,
                    dateAdded: new Date().toLocaleDateString()
                };
                
                items.push(newItem);
                saveLocalData();
                displayItemsAdmin();
                displayStoreItems();
                
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemStock').value = '';
                document.getElementById('itemDesc').value = '';
                
                alert('Material added to local storage!');
            }
        }

        // Admin: Add category
        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if(!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            if(categories.includes(categoryName)) {
                alert('Category already exists!');
                return;
            }
            
            try {
                await addCategoryToSupabase(categoryName);
                categories.push(categoryName);
                saveLocalData();
                displayCategoriesAdmin();
                initializeCategoryDropdown();
                
                document.getElementById('newCategoryName').value = '';
                alert(`Category "${categoryName}" added successfully to database!`);
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category to database. Added locally instead.');
                
                categories.push(categoryName);
                saveLocalData();
                displayCategoriesAdmin();
                initializeCategoryDropdown();
                
                document.getElementById('newCategoryName').value = '';
                alert(`Category "${categoryName}" added to local storage!`);
            }
        }

        // Update stock in Supabase when changing cart quantities
        async function updateCartQuantity(index, newQuantity) {
            const cartItem = cart[index];
            const item = items.find(i => i.id == cartItem.itemId);
            
            if(item && newQuantity > 0) {
                const stockChange = newQuantity - cartItem.quantity;
                
                if(item.stock >= stockChange) {
                    cartItem.quantity = newQuantity;
                    item.stock -= stockChange;
                    
                    // Update stock in Supabase
                    await updateItemStock(item.id, item.stock);
                    
                    saveLocalData();
                    displayCart();
                    displayStoreItems();
                    updateCartCount();
                    displayCheckoutSummary();
                } else {
                    alert('Not enough stock available!');
                }
            } else if(newQuantity <= 0) {
                removeFromCart(index);
            }
        }

        // Remove from cart and restore stock
        async function removeFromCart(index) {
            const cartItem = cart[index];
            const item = items.find(i => i.id == cartItem.itemId);
            
            if(item) {
                item.stock += cartItem.quantity;
                
                // Update stock in Supabase
                await updateItemStock(item.id, item.stock);
                
                cart.splice(index, 1);
                saveLocalData();
                displayCart();
                displayStoreItems();
                updateCartCount();
                displayCheckoutSummary();
            }
        }

        // Clear cart and restore all stock
        async function clearCart() {
            if(cart.length === 0) return;
            
            if(confirm('Clear your cart?')) {
                for (const cartItem of cart) {
                    const item = items.find(i => i.id == cartItem.itemId);
                    if(item) {
                        item.stock += cartItem.quantity;
                        await updateItemStock(item.id, item.stock);
                    }
                }
                
                cart = [];
                saveLocalData();
                displayCart();
                displayStoreItems();
                updateCartCount();
                displayCheckoutSummary();
            }
        }

        // Save local data as backup
        function saveLocalData() {
            localStorage.setItem('infxItems', JSON.stringify(items));
            localStorage.setItem('infxCart', JSON.stringify(cart));
            localStorage.setItem('infxOrders', JSON.stringify(orders));
            localStorage.setItem('infxOrderCounter', orderCounter.toString());
            localStorage.setItem('infxCategories', JSON.stringify(categories));
        }

        // ==============================================
        // YOUR EXISTING UI FUNCTIONS (mostly unchanged)
        // ==============================================
        // These functions remain the same as in your original code:
        // - initializeCategoryDropdown()
        // - displayCategoriesAdmin()
        // - switchTab()
        // - displayCheckoutSummary()
        // - updateHomeStats()
        // - filterCategory()
        // - displayStoreItems()
        // - addToCart()
        // - updateCartCount()
        // - displayCart()
        // - displayCustomerOrders()
        // - trackSpecificOrder()
        // - trackOrder()
        // - viewOrderDetails()
        // - cancelOrder()
        // - searchOrders()
        // - showAdminPanel()
        // - hideAdminPanel()
        // - verifyAdmin()
        // - switchAdminTab()
        // - displayItemsAdmin()
        // - updateItemCategory()
        // - updateStock() // Modified for Supabase
        // - deleteItem()
        // - displayOrdersAdmin()
        // - searchAdminOrders()
        // - exportToExcel()
        // - backupData()
        // - updateStoreLink()
        // - copyStoreLink()
        
        // Note: Some functions above have been modified for Supabase integration
        // but their core logic remains similar to your original code.

        // Initialize app on load
        window.onload = initializeApp;
    </script>
</body>
</html>